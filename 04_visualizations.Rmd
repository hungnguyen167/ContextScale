---
title: "R Notebook"
output: html_notebook
---
## Setup and load data

```{r echo=FALSE, message=FALSE, warning=FALSE}

rm(list=ls())
pacman::p_load(quanteda, quanteda.textmodels, tidyverse, readr, ggplot2, rstatix, grid, gridExtra, viridis, ggsci, ggpubr, ragg, scales, caret, ggExtra,rempsyc, dplyr, flextable, magrittr, gt, scico)





## d2v
d2v_gen <- read_csv("data/py_outputs/r&c_gen_party_election.csv") %>% 
    mutate(election = as.numeric(election)) 
d2v_topic <- read_csv("data/py_outputs/r&c_party_election_topic.csv") %>% 
    mutate(election = as.numeric(election)) 
d2v_tw <- read_csv("data/py_outputs/r&c_tw.csv") 


## Wordfish
wf_gen <- read.csv("data/r_outputs/wf_gen_all_countries.csv")
wf_topic <- read_csv("data/r_outputs/wf_topic_all_countries.csv")
wf_tw <- read_csv("data/r_outputs/wf_tw.csv")

## CHES 

ches <- read_csv("data/r_outputs/ches_cleaned.csv")

## Datasets

manifesto_cs_topic <- read_csv("data/py_outputs/ensemble_full_dataset.csv")
manifesto_org <- read_csv("data/temps/manifesto.csv") 
tw_processed <- read_csv("data/py_outputs/tw_processed.csv")
tw_cs <- read_csv("data/py_outputs/cs_tw.csv")

## performance metrics tables

base_topic <- read_csv("results/classification results/base_topic.csv")
base_sentiment <- read_csv("results/classification results/base_sentiment.csv")

sf_topic <- read_csv("results/classification results/sf_topic.csv")
sf_sentiment <- read_csv("results/classification results/sf_sentiment.csv")

test_topic <- read_csv("results/classification results/test_topic.csv")
test_sentiment <- read_csv("results/classification results/test_sentiment.csv")

dg_topic <- read_csv("results/classification results/dg_topic.csv")
dg_sentiment <- read_csv("results/classification results/dg_sentiment.csv")

dl_topic <- read_csv("results/classification results/dl_topic.csv")
dl_sentiment <- read_csv("results/classification results/dl_sentiment.csv")

dl_10_topic <- read_csv("results/classification results/dl_10_topic.csv")
dl_10_sentiment <- read_csv("results/classification results/dl_10_sentiment.csv")

cagree_noft_topic <- read_csv("results/classification results/cagree_noft_topic.csv")
cagree_noft_sentiment <- read_csv("results/classification results/cagree_noft_sentiment.csv")

cagree_10ft_topic <- read_csv("results/classification results/cagree_10ft_topic.csv")
cagree_10ft_sentiment <- read_csv("results/classification results/cagree_10ft_sentiment.csv")

tw_20ft_topic <- read_csv("results/classification results/tw_20ft_topic.csv")
tw_20ft_sentiment <- read_csv("results/classification results/tw_20ft_sentiment.csv")

```



## Grouping scores by topics 

```{r message=FALSE, warning=FALSE}
manifesto_meta <- manifesto_org %>%
    dplyr::select(-country) %>%
    rename(country=countryname) %>%
    distinct(country, party, election, name)

manifesto_aggr <- manifesto_cs_topic %>%
    filter(topic != "Other") %>%
    left_join(manifesto_meta, 
              by = c("country","party","election")) %>%
    group_by(country, party, election) %>%
    summarise(
        n = n(),
        party_mean_score = round(mean(mean_position_score, na.rm=TRUE),2), 
        within_var = sum(epistemic_variance, na.rm=TRUE) / (n^2),
        between_var = var(mean_position_score, na.rm=TRUE) / n,
        total_var = within_var + between_var,
        party_se = sqrt(total_var),
        ci_low = party_mean_score - 1.96 * party_se,
        ci_high = party_mean_score + 1.96 * party_se,
        .groups = "drop"
    ) 
  

manifesto_topic_aggr <- manifesto_cs_topic %>% 
    left_join(manifesto_meta, by = c("country","party","election")) %>%
    group_by(country, party, election, topic) %>%
    summarise(
        n = n(),
        party_mean_score = round(mean(mean_position_score, na.rm=TRUE),2), 
        within_var = sum(epistemic_variance, na.rm=TRUE) / (n^2),
        between_var = var(mean_position_score, na.rm=TRUE) / n,
        total_var = within_var + between_var,
        party_se = sqrt(total_var),
        ci_low = party_mean_score - 1.96 * party_se,
        ci_high = party_mean_score + 1.96 * party_se,
        .groups = "drop"
    )

manifesto_spec_topic <- manifesto_cs_topic %>% 
    left_join(manifesto_meta, by = c("country","party","election")) %>%
    mutate(
        spec_topic = case_when(
            cmp_code == "501" ~ "Environment Protection",
            cmp_code %in% c("504","505") ~ "Welfare Expansion/Retrenchment",
            TRUE ~ "Other"
        )
    ) %>%
    filter(spec_topic != "Other") %>%
    group_by(country, party, election, spec_topic) %>%
    summarise(
        n = n(),
        party_mean_score = round(mean(mean_position_score, na.rm=TRUE),2), 
        within_var = sum(epistemic_variance, na.rm=TRUE) / (n^2),
        between_var = var(mean_position_score, na.rm=TRUE) / n,
        total_var = within_var + between_var,
        party_se = sqrt(total_var),
        ci_low = party_mean_score - 1.96 * party_se,
        ci_high = party_mean_score + 1.96 * party_se,
        .groups = "drop"
    )

manifesto_deu <- manifesto_org %>%
    filter(countryname=="Germany") %>%
    mutate(
        party_name = case_when(
          party %in% c(41111,41112,41113) ~ "Alliance 90/Greens",
          party %in% c(41220, 41221, 41222, 41223) ~ "The Left",
          party == 41320 ~ "SPD",
          party == 41420 ~ "FDP",
          party == 41521 ~ "CDU/CSU",
          party == 41953 ~ "AfD",
          TRUE ~ "Other"  
        )
    ) %>%
    rename(party_id=party) %>%
    filter(party_name!="Other") 

logscale <- manifesto_org %>%
    group_by(countryname, party, election, topic, sentiment) %>%
    summarise(n = n(), .groups = "drop") %>%
    group_by(countryname, party, election, topic) %>%
    reframe(
        n_right = sum(n[sentiment=="right"], na.rm=TRUE),
        n_left = sum(n[sentiment=="left"], na.rm=TRUE),
        lr_log = round(
            log(n_right+0.5) - log(n_left+0.5),
            2
        )
    ) %>%
    rename(country = countryname)

logscale_gen <- logscale %>%
    group_by(country, party, election) %>%
    summarise(
        lr_log_gen = mean(lr_log, na.rm=TRUE),
        lr_log_se = sd(lr_log, na.rm=TRUE)/sqrt(n()),
        .groups = "drop"
    )

logscale_spec <- manifesto_org %>%
    mutate(
        spec_topic = case_when(
            cmp_code == "501" ~ "Environment Protection",
            cmp_code %in% c("504","505") ~ "Welfare Expansion/Retrenchment",
            TRUE ~ "Other"
        )
    ) %>%
    filter(spec_topic != "Other") %>%
    group_by(countryname, party, election, spec_topic, sentiment) %>%
    summarise(n = n(), .groups = "drop") %>%
    group_by(countryname, party, election, spec_topic) %>%
    reframe(
        n_right = sum(n[sentiment=="right"], na.rm=TRUE),
        n_left = sum(n[sentiment=="left"], na.rm=TRUE),
        lr_log = round(
            log(n_right+0.5) - log(n_left+0.5),
            2
        )
    ) %>%
    rename(country = countryname)

tw_log <- tw_processed %>%
    group_by(topic, lr) %>%
    summarise(
        n = n(),
        n_right = sum(lr=="right", na.rm=TRUE),
        n_left = sum(lr=="left", na.rm=TRUE),
        lr_log_tw = round(
            log(n_right+0.5) - log(n_left+0.5),
            2
        ),
        .groups = "drop"
    ) 

cs_tw_aggr <- tw_cs %>%
    group_by(topic, lr) %>%
    summarise(
        n = n(),
        group_mean_score = round(mean(mean_position_score, na.rm=TRUE),2), 
        within_var = sum(epistemic_variance, na.rm=TRUE) / (n^2),
        between_var = var(mean_position_score, na.rm=TRUE) / n,
        total_var = within_var + between_var,
        group_se = sqrt(total_var),
        ci_low = group_mean_score - 1.96 * group_se,
        ci_high = group_mean_score + 1.96 * group_se,
        .groups = "drop"
    )


```

## Figure 2 
```{r figure_2}
df_gen_deu <-  manifesto_aggr %>%
    left_join(d2v_gen, by = c("country","party", "election")) %>%
    left_join(wf_gen, by = c("country","party", "election")) %>% 
    left_join(logscale_gen, by = c("country","party","election")) %>%
    filter(country == "Germany") %>%
    mutate(
        party_name = case_when(
          party %in% c(41111,41112,41113) ~ "Alliance 90/Greens",
          party %in% c(41220, 41221, 41222, 41223) ~ "The Left",
          party == 41320 ~ "SPD",
          party == 41420 ~ "FDP",
          party == 41521 ~ "CDU/CSU",
          party == 41953 ~ "AfD",
          TRUE ~ "Other"  
        )
    ) %>%
    dplyr::select(-party) %>%
    rename(party=party_name) %>%
    filter(party!= "Other") 

plot_wf_gen_deu <- ggplot(data = df_gen_deu,
                  aes(x=factor(election), y=wf_score, color=party,group=party)) +
    geom_point() +
    geom_line(alpha=0.8, linewidth = 1) + 
    geom_errorbar(aes(ymin=wf_score-wf_se, ymax=wf_score+wf_se),
                  width=.2,alpha=0.5,linetype="dashed")+
    scale_color_manual(name = "Party",  
                       values = c("blue","green", "black","gold", "red", "purple")) +
    theme(axis.title = element_text(size = 15),legend.title = element_text(size = 15), legend.text = element_text(size = 14), title =  element_text(size = 18, face = "bold")) +
    xlab("Election") +
    ylab("Wordfish - General Dimension") 


plot_d2v_gen_deu <- ggplot(data = df_gen_deu,
                  aes(x=factor(election), y=d2v_d1, color=party,group=party)) +
    geom_point() +
    geom_line(alpha=0.8, linewidth = 1) + 
    scale_color_manual(name = "Party",  
                       values = c("blue","green", "black","gold", "red", "purple")) +
    theme(axis.title = element_text(size = 15),legend.title = element_text(size = 15), legend.text = element_text(size = 14), title =  element_text(size = 18, face = "bold")) +
    xlab("Election") +
    ylab("R&C - General Dimension") 

plot_cmplog_gen_deu <- ggplot(data = df_gen_deu,
                  aes(x=factor(election), y=lr_log_gen, color=party,group=party)) +
    geom_point() +
    geom_line(alpha=0.8, linewidth = 1) + 
    scale_color_manual(name = "Party",  
                       values = c("blue","green", "black","gold", "red", "purple")) +
    theme(axis.title = element_text(size = 15),legend.title = element_text(size = 15), legend.text = element_text(size = 14), title =  element_text(size = 18, face = "bold")) +
    xlab("Election") +
    ylab("LogScale (Lowe et al.) - General Dimension") +
    ylim(-5,5)


plot_cs_gen_deu <- ggplot(data = df_gen_deu,
                  aes(x=factor(election), y=party_mean_score, color=party,group=party)) +
    geom_point() +
    geom_line(alpha=0.8, linewidth = 1) + 
    geom_errorbar(aes(ymin=party_mean_score-party_se, ymax=party_mean_score+party_se),
                  width=.2,alpha=0.5,linetype="dashed")+
    scale_color_manual(name = "Party",  
                       values = c("blue","green", "black","gold", "red", "purple")) +
    theme(axis.title = element_text(size = 15),legend.title = element_text(size = 15), legend.text = element_text(size = 14), title =  element_text(size = 18, face = "bold")) +
    xlab("Election") +
    ylab("ContextScale - General Dimension") + 
    ylim(-1,1)


figure_2 <- ggarrange(
      plot_cmplog_gen_deu, plot_d2v_gen_deu, plot_wf_gen_deu,
      plot_cs_gen_deu,
      common.legend = TRUE
)



agg_png(filename = here::here("results","tabs and figs","figure 2.png"), res = 360, width = 4800, height = 3600)
figure_2
invisible(dev.off())

agg_tiff(filename = here::here("results","tabs and figs","figure 2.tiff"), res = 360, width = 4800, height = 3600)
figure_2
invisible(dev.off())

```

## Figure 3 
```{r figure_3}


df_eu_deu <-  manifesto_topic_aggr %>%
    left_join(d2v_topic, by = c("country","party", "election", "topic")) %>%
    left_join(wf_topic, by = c("country","party", "election", "topic")) %>% 
    left_join(logscale, by = c("country","party","election", "topic")) %>%
    filter(country == "Germany" & topic == "European Integration") %>%
    mutate(
        party_name = case_when(
          party %in% c(41111,41112,41113) ~ "Alliance 90/Greens",
          party %in% c(41220, 41221, 41222, 41223) ~ "The Left",
          party == 41320 ~ "SPD",
          party == 41420 ~ "FDP",
          party == 41521 ~ "CDU/CSU",
          party == 41953 ~ "AfD",
          TRUE ~ "Other"  
        )
    ) %>%
    dplyr::select(-party) %>%
    rename(party=party_name) %>%
    filter(party!= "Other") 

df_wf_deu <-  manifesto_topic_aggr %>%
    left_join(d2v_topic, by = c("country","party", "election", "topic")) %>%
    left_join(wf_topic, by = c("country","party", "election", "topic")) %>% 
    left_join(logscale, by = c("country","party","election", "topic")) %>%
    filter(country == "Germany" & topic == "Labour and Social Welfare") %>%
    mutate(
        party_name = case_when(
          party %in% c(41111,41112,41113) ~ "Alliance 90/Greens",
          party %in% c(41220, 41221, 41222, 41223) ~ "The Left",
          party == 41320 ~ "SPD",
          party == 41420 ~ "FDP",
          party == 41521 ~ "CDU/CSU",
          party == 41953 ~ "AfD",
          TRUE ~ "Other"  
        )
    ) %>%
    dplyr::select(-party) %>%
    rename(party=party_name) %>%
    filter(party!= "Other") 



plot_cs_wf <- ggplot(data = df_wf_deu,
                  aes(x=factor(election), y=party_mean_score, color=party,group=party)) +
    geom_point() +
    geom_line(alpha=0.8, linewidth = 1) + 
    geom_errorbar(aes(ymin=party_mean_score-party_se, ymax=party_mean_score+party_se),
                  width=.2,alpha=0.5,linetype="dashed")+
    scale_color_manual(name = "Party",  
                       values = c("blue","green", "black","gold", "red", "purple")) +
    theme(axis.title = element_text(size = 15),legend.title = element_text(size = 15), legend.text = element_text(size = 14), title =  element_text(size = 18, face = "bold")) +
    xlab("Election") +
    ylab("ContextScale - Labour and Social Welfare") + 
    ylim(-1,1)

plot_cs_eu <- ggplot(data = df_eu_deu,
                  aes(x=factor(election), y=party_mean_score, color=party,group=party)) +
    geom_point() +
    geom_line(alpha=0.8, linewidth = 1) + 
    geom_errorbar(aes(ymin=party_mean_score-party_se, ymax=party_mean_score+party_se),
                  width=.2,alpha=0.5,linetype="dashed")+
    scale_color_manual(name = "Party",  
                       values = c("blue","green", "black","gold", "red", "purple")) +
    theme(axis.title = element_text(size = 15),legend.title = element_text(size = 15), legend.text = element_text(size = 14), title =  element_text(size = 18, face = "bold")) +
    xlab("Election") +
    ylab("ContextScale - European Integration") + 
    ylim(-1,1)



figure_3 <- ggarrange(
      plot_cs_wf, plot_cs_eu,
      common.legend = TRUE
)



agg_png(filename = here::here("results","tabs and figs","figure 3.png"), res = 360, width = 4800, height = 2400)
figure_3
invisible(dev.off())


```

## Figure 4: Testing on Twitter Datasets

```{r figure_4}
# Prepare datasets for Figure 4: Twitter datasets comparison
# Combine 4 different methods (tw_log, cs_tw_aggr, d2v_tw, wf_tw)

# 1. tw_log: contains lr_log_tw with topic and lr grouping
tw_log_prep <- tw_log %>%
    mutate(method = "LogScale (Twitter)") %>%
    rename(score = lr_log_tw) %>%
    dplyr::select(topic, lr, score, method, n) %>%
    mutate(se = NA_real_)  # No standard error available

# 2. cs_tw_aggr: contains group_mean_score with topic and lr grouping
cs_tw_prep <- cs_tw_aggr %>%
    mutate(method = "ContextScale (Twitter)") %>%
    rename(score = group_mean_score, se = group_se) %>%
    dplyr::select(topic, lr, score, method, n, se)

# 3. d2v_tw: contains d2v_d1 with topic and lr grouping
# Get n from cs_tw_aggr (same for each topic-lr combination)
d2v_tw_prep <- d2v_tw %>%
    mutate(method = "R&C - Dimension 1 (Twitter)") %>%
    rename(score = d2v_d1) %>%
    dplyr::select(topic, lr, score, method) %>%
    left_join(
        cs_tw_aggr %>% dplyr::select(topic, lr, n),
        by = c("topic", "lr")
    ) %>%
    mutate(se = NA_real_)  # No standard error available

# 4. wf_tw: contains wf_score with topic and lr grouping
wf_tw_prep <- wf_tw %>%
    mutate(
        method = "Wordfish (Twitter)",
        score = wf_score,
        se = wf_se
    ) %>%
    dplyr::select(topic, lr, score, method, num_speeches, se) %>%
    rename(n = num_speeches)

# Combine all datasets
fig4_twitter_df <- bind_rows(tw_log_prep, cs_tw_prep, d2v_tw_prep, wf_tw_prep)

# Create separate plots with individual scales for each method
# Plot 1: LogScale
p_logscale <- ggplot(fig4_twitter_df %>% filter(method == "LogScale (Twitter)"), 
                     aes(x = factor(lr, levels = c("left", "right")), 
                         y = score, 
                         fill = topic)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
    geom_text(aes(label = paste0("n=", n)), 
              position = position_dodge(width = 0.8), 
              vjust = -0.7,
              size = 4, fontface = "bold", color = "#333333") +
    scale_y_continuous(limits = c(-12, 12)) +
    scale_fill_manual(name = "Topic", values = c("#1f77b4", "#ff7f0e", "#2ca02c")) +
    ggtitle("LogScale (Twitter)") +
    xlab("Left-Right Position") +
    ylab("Mean Position Score") +
    theme_bw(base_size = 14) +
    theme(legend.position = "none",
          plot.title = element_text(size = 12, face = "bold"),
          axis.title = element_text(size = 14, face = "bold")) 

# Plot 2: ContextScale
p_cs <- ggplot(fig4_twitter_df %>% filter(method == "ContextScale (Twitter)"), 
               aes(x = factor(lr, levels = c("left", "right")), 
                   y = score, 
                   fill = topic)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
    geom_text(aes(label = paste0("n=", n)), 
              position = position_dodge(width = 0.8), 
              vjust = -0.7,
              size = 4, fontface = "bold", color = "#333333") +
    scale_y_continuous(limits = c(-1, 1)) +
    scale_fill_manual(name = "Topic", values = c("#1f77b4", "#ff7f0e", "#2ca02c")) +
    ggtitle("ContextScale (Twitter)") +
    xlab("Left-Right Position") +
    ylab("Mean Position Score") +
    theme_bw(base_size = 14) +
    theme(legend.position = "none",
          plot.title = element_text(size = 12, face = "bold"),
          axis.title = element_text(size = 14, face = "bold"))

# Plot 3: R&C
p_rc <- ggplot(fig4_twitter_df %>% filter(method == "R&C - Dimension 1 (Twitter)"), 
               aes(x = factor(lr, levels = c("left", "right")), 
                   y = score, 
                   fill = topic)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
    geom_text(aes(label = paste0("n=", n)), 
              position = position_dodge(width = 0.8), 
              vjust = -0.7,
              size = 4, fontface = "bold", color = "#333333") +
    scale_y_continuous(limits = c(-40, 20)) +
    scale_fill_manual(name = "Topic", values = c("#1f77b4", "#ff7f0e", "#2ca02c")) +
    ggtitle("R&C - Dimension 1 (Twitter)") +
    xlab("Left-Right Position") +
    ylab("Mean Position Score") +
    theme_bw(base_size = 14) +
    theme(legend.position = "none",
          plot.title = element_text(size = 12, face = "bold"),
          axis.title = element_text(size = 14, face = "bold"))

# Plot 4: Wordfish
p_wf <- ggplot(fig4_twitter_df %>% filter(method == "Wordfish (Twitter)"), 
               aes(x = factor(lr, levels = c("left", "right")), 
                   y = score, 
                   fill = topic)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
    geom_text(aes(label = paste0("n=", n)), 
              position = position_dodge(width = 0.8), 
              vjust = -0.7,
              size = 4, fontface = "bold", color = "#333333") +
    scale_y_continuous(limits = c(-1, 1.5)) +
    scale_fill_manual(name = "Topic", values = c("#1f77b4", "#ff7f0e", "#2ca02c")) +
    ggtitle("Wordfish (Twitter)") +
    xlab("Left-Right Position") +
    ylab("Mean Position Score") +
    theme_bw(base_size = 14) +
    theme(legend.position = "top",
          plot.title = element_text(size = 12, face = "bold"),
          axis.title = element_text(size = 14, face = "bold"))

# Combine plots with individual scales
figure_4_twitter <- ggarrange(p_logscale, p_cs, p_rc, p_wf,
                              ncol = 2, nrow = 2,
                              common.legend = TRUE,
                              legend = "top")

agg_png(filename = here::here("results", "tabs and figs", "figure 4.png"), res = 360, width = 4800, height = 3600)
print(figure_4_twitter)
invisible(dev.off())

```

## Figure 5
```{r figure_5}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#0072B2", "#F0E442", "#D55E00", "#CC79A7")

manifesto_test_sent <- data.frame(t(
    round(colMeans(test_sentiment),2)
  )) %>%
  mutate(
    model = "Model 1\nTest Set",
    prediction_task = "Sentiment"
  )
manifesto_test_topic <- data.frame(t(
    round(colMeans(test_topic),2)
  )) %>%
  mutate(
    model = "Model 1\nTest Set",
    prediction_task = "Topic"
  )

manifesto_diff_sent <- data.frame(t(
    round(colMeans(dl_sentiment),2)
  )) %>%
  mutate(
    model = "Model 2\nDifferent Languages",
    prediction_task = "Sentiment"
  )
manifesto_diff_topic <- data.frame(t(
    round(colMeans(dl_topic),2)
  )) %>%
  mutate(
    model = "Model 2\nDifferent Languages",
    prediction_task = "Topic"
  )

cagree10_sent <- data.frame(t(
    round(colMeans(cagree_10ft_sentiment),2)
  )) %>%
  mutate(
    model = "Model 4\nCOALITIONAGREE\n(10% FT)",
    prediction_task = "Sentiment"
  )
cagree10_topic <- data.frame(t(
    round(colMeans(cagree_10ft_topic),2)
  )) %>%
  mutate(
    model = "Model 4\nCOALITIONAGREE\n(10% FT)",
    prediction_task = "Topic"
  )

cagree_sent <- data.frame(t(
    round(colMeans(cagree_noft_sentiment),2)
  )) %>%
  mutate(
    model = "Model 3\nCOALITIONAGREE\n(No FT)",
    prediction_task = "Sentiment"
  )
cagree_topic <- data.frame(t(
    round(colMeans(cagree_noft_topic),2)
  )) %>%
  mutate(
    model = "Model 3\nCOALITIONAGREE\n(No FT)",
    prediction_task = "Topic"
  )

tweets_sent <- data.frame(t(
    round(colMeans(tw_20ft_sentiment),2)
  )) %>%
  mutate(
    model = "Model 5\nTweets\n(20% FT)",
    prediction_task = "Sentiment"
  )
tweets_topic <- data.frame(t(
    round(colMeans(tw_20ft_topic),2)
  )) %>%
  mutate(
    model = "Model 5\nTweets\n(20% FT)",
    prediction_task = "Topic"
  )

fig5_df <- bind_rows(manifesto_test_sent, manifesto_test_topic, manifesto_diff_sent, manifesto_diff_topic,
                     cagree10_sent, cagree10_topic, cagree_sent, cagree_topic, tweets_sent, tweets_topic) %>%
    mutate(
      label = case_when(
        f1 == max(f1) ~ as.character(f1),
        f1 == min(f1) ~ as.character(f1),
        TRUE ~ NA_character_
      )
    )



fig5_long <- fig5_df %>%
    pivot_longer(cols = c(f1, accuracy, precision, recall), 
                 names_to = "metric", 
                 values_to = "score")



figure_5 <- ggplot(fig5_long, aes(x = model, y = score, fill = prediction_task)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
    geom_text(aes(label = round(score, 2)), 
              position = position_dodge(width = 0.8), 
              vjust = -1.2,  # Moves annotations higher
              size = 5) +  # Adjust text size if needed
    scale_fill_manual(values = c("steelblue", "darkorange")) +
    facet_wrap(~ metric, scales = "free_y") +  # Separate panels for each metric
    xlab("Validation Model") +
    ylab("Score") +
    expand_limits(y = max(fig5_long$score) + 0.23) +  # Adds extra space above bars
    theme_bw(base_size = 14) +
    theme(legend.position = "top",
          text = element_text(size = 14),
          axis.title = element_text(size = 16),
          axis.text = element_text(size = 12),
          axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
          legend.title = element_text(size = 14),
          legend.text = element_text(size = 12),
          panel.spacing = unit(1.2, "lines")) +  # Add more space between facets
    labs(fill = "Prediction Task")


agg_png(filename = here::here("results", "tabs and figs", "figure 5.png"), res = 360, width = 4800, height = 3200)
print(figure_5)
invisible(dev.off())
```

## Table A1


```{r table_a1}
agg_sent <- manifesto_deu %>%
    filter(lrn != "neutral" & topic != "Other") %>%
    group_by(party) %>%
    summarise(count_topic = n())
md_sum <- manifesto_deu %>%
    filter(lrn != "neutral" & topic != "Other") %>%
    group_by(party, topic) %>%
    count(lrn) %>%
    pivot_wider(names_from = lrn, values_from = n, values_fill=0) %>%
    left_join(agg_sent, by = "party") %>%
    mutate(
        c_overall = round(sum(left, right)/count_topic,2)
    ) %>%
    dplyr::select(-count_topic)



table_a1 <- md_sum %>% flextable() %>%
    merge_v(j=c("party","topic"), combine=FALSE) %>%
    set_header_labels(
        "party" = "Party",
        "coalition_topic" = "Topic",
        "left" = "Number left",
        "right" = "Number right",
        "c_overall" = "centage topic in corpus"
    )

save_as_docx(table_a1, path ="results/tabs and figs/table_a1.docx", align="left")


```

## Figure A1

```{r}
base_topic <- read_csv("results/classification results/base_topic.csv")
base_sentiment <- read_csv("results/classification results/base_sentiment.csv")

sf_topic <- read_csv("results/classification results/sf_topic.csv")
sf_sentiment <- read_csv("results/classification results/sf_sentiment.csv")

sa_topic <- read_csv("results/classification results/sa_topic.csv")
sa_sentiment <- read_csv("results/classification results/sa_sentiment.csv")

dg_topic <- read_csv("results/classification results/dg_topic.csv")
dg_sentiment <- read_csv("results/classification results/dg_sentiment.csv")

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#0072B2", "#F0E442", "#D55E00", "#CC79A7")

base_topic <- data.frame(t(
    round(colMeans(base_topic),2)
  )) %>%
  mutate(
    model = "Base Multitask Model",
    prediction_task = "Topic"
  )

base_sentiment <- data.frame(t(
    round(colMeans(base_sentiment),2)
  )) %>%
  mutate(
    model = "Base Multitask Model",
    prediction_task = "Sentiment"
  )

sf_topic <- data.frame(t(
    round(colMeans(sf_topic),2)
  )) %>%
  mutate(
    model = "Simple Flow Model",
    prediction_task = "Topic"
  )

sf_sentiment <- data.frame(t(
    round(colMeans(sf_sentiment),2)
  )) %>%
  mutate(
    model = "Simple Flow Model",
    prediction_task = "Sentiment"
  )

sa_topic <- data.frame(t(
    round(colMeans(sa_topic),2)
  )) %>%
  mutate(
    model = "Shared Attention Model",
    prediction_task = "Topic"
  )

sa_sentiment <- data.frame(t(
    round(colMeans(sa_sentiment),2)
  )) %>%
  mutate(
    model = "Shared Attention Model",
    prediction_task = "Sentiment"
  )

dg_topic <- data.frame(t(
    round(colMeans(dg_topic),2)
  )) %>%
  mutate(
    model = "Dynamic Gating Model",
    prediction_task = "Topic"
  )

dg_sentiment <- data.frame(t(
    round(colMeans(dg_sentiment),2)
  )) %>%
  mutate(
    model = "Dynamic Gating Model",
    prediction_task = "Sentiment"
  )

figa1_df <- bind_rows(base_topic, dg_topic, sa_topic, sf_topic,
                     base_sentiment, dg_sentiment, sa_sentiment, sf_sentiment) %>%
    mutate(
      label = case_when(
        f1 == max(f1) ~ as.character(f1),
        f1 == min(f1) ~ as.character(f1),
        TRUE ~ NA_character_
      )
    )

figa1_long <- figa1_df %>%
    pivot_longer(cols = c(f1, accuracy, precision, recall), 
                 names_to = "metric", 
                 values_to = "score")



figure_a1 <- ggplot(figa1_long, aes(x = model, y = score, fill = prediction_task)) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
    geom_text(aes(label = round(score, 2)), 
              position = position_dodge(width = 0.8), 
              vjust = -1.2,  # Moves annotations higher
              size = 5) +  # Adjust text size if needed
    scale_fill_manual(values = c("steelblue", "darkorange")) +
    facet_wrap(~ metric, scales = "free_y") +  # Separate panels for each metric
    xlab("Validation Model") +
    ylab("Score") +
    expand_limits(y = max(figa1_long$score) + 0.15) +  # Adds extra space above bars
    theme_bw(base_size = 14) +
    theme(legend.position = "top",
          text = element_text(size = 14),
          axis.title = element_text(size = 16),
          axis.text = element_text(size = 12),
          axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
          legend.title = element_text(size = 14),
          legend.text = element_text(size = 12),
          panel.spacing = unit(1.2, "lines")) +  # Add more space between facets
    labs(fill = "Prediction Task")




agg_png(filename = here::here("results", "tabs and figs", "figure A1.png"), res = 360, width = 4800, height = 3200)
print(figure_a1)
invisible(dev.off())
```


## Correlation tables for figure A2

```{r}


df_gen <- manifesto_aggr %>%
    filter(!is.na(party)) %>%
    left_join(d2v_gen, by = c("country","party", "election")) %>%
    left_join(wf_gen, by = c("country","party", "election")) %>%
    left_join(logscale_gen, by = c("country","party","election")) 

df_env <-  manifesto_topic_aggr %>%
    left_join(d2v_topic, by = c("country","party", "election","topic")) %>%
    left_join(wf_topic, by = c("country","party", "election","topic")) %>% 
    left_join(logscale, by = c("country","party","election", "topic")) %>%
    filter(topic == "Environment - Growth") %>%
    filter(!is.na(party)) 


df_imm <-  manifesto_topic_aggr %>%
    left_join(d2v_topic, by = c("country","party", "election", "topic")) %>%
    left_join(wf_topic, by = c("country","party", "election", "topic")) %>% 
    left_join(logscale, by = c("country","party","election", "topic")) %>%
    filter(topic == "Immigration") %>% 
    filter(!is.na(party))

df_eu <-  manifesto_topic_aggr %>%
    left_join(d2v_topic, by = c("country","party", "election", "topic")) %>%
    left_join(wf_topic, by = c("country","party", "election", "topic")) %>% 
    left_join(logscale, by = c("country","party","election", "topic")) %>%
    filter(topic == "European Integration") %>% 
    filter(!is.na(party)) 

df_socwel <-  manifesto_topic_aggr %>%
   left_join(d2v_topic, by = c("country","party", "election", "topic")) %>%
    left_join(wf_topic, by = c("country","party", "election", "topic")) %>% 
    left_join(logscale, by = c("country","party","election", "topic")) %>%
    filter(topic == "Labour and Social Welfare") %>% 
    filter(!is.na(party)) 

df_econ <-  manifesto_topic_aggr %>%
    left_join(d2v_topic, by = c("country","party", "election", "topic")) %>%
    left_join(wf_topic, by = c("country","party", "election", "topic")) %>% 
    left_join(logscale, by = c("country","party","election", "topic")) %>%
    filter(topic == "Economics") %>% 
    filter(!is.na(party)) 



cor_table_gen <- df_gen %>% 
    cor_test(vars = "party_mean_score", vars2 = c("wf_score", "lr_log_gen",
                                          "d2v_d1"), use="complete.obs") 

cor_table_gen <- round(cor_table_gen[,c("cor", "p", "conf.low", "conf.high")], 2) %>%
    mutate(
        techniques = c("wf", "cmp","d2v1"),
        topic = "General"
    )


cor_table_econ <- df_econ %>% 
    cor_test(vars = "party_mean_score", vars2 = c("wf_score", "lr_log",
                                               "d2v_d1"))

cor_table_econ <- round(cor_table_econ[,c("cor", "p", "conf.low", "conf.high")], 2) %>%
    mutate(
        techniques = c("wf","cmp", "d2v1"),
        topic = "Economics"
    )

cor_table_env <- df_env %>% cor_test(vars = "party_mean_score",
                                       vars2=c("wf_score", "lr_log",
                                               "d2v_d1")) 

cor_table_env <- round(cor_table_env[,c("cor", "p", "conf.low", "conf.high")], 2) %>%
    mutate(
        techniques = c("wf", "cmp","d2v1"),
        topic = "Environment - Growth"
    )


cor_table_socwel <- df_socwel %>% cor_test(vars = "party_mean_score",
                                       vars2=c("wf_score", "lr_log",
                                               "d2v_d1"))

cor_table_socwel <- round(cor_table_socwel[,c("cor", "p", "conf.low", "conf.high")], 2) %>%
    mutate(
        techniques = c("wf","cmp", "d2v1"),
        topic = "Labour and Social Welfare"
    )

cor_table_eu <- df_eu %>% cor_test(vars = "party_mean_score",
                                       vars2=c("wf_score", "lr_log",
                                               "d2v_d1"))

cor_table_eu <- round(cor_table_eu[,c("cor", "p", "conf.low", "conf.high")], 2) %>%
    mutate(
        techniques = c("wf","cmp", "d2v1"),
        topic = "European Integration"
    )
cor_table_imm <- df_imm %>% cor_test(vars = "party_mean_score",
                                       vars2=c("wf_score", "lr_log",
                                               "d2v_d1"))

cor_table_imm <- round(cor_table_imm[,c("cor", "p", "conf.low", "conf.high")], 2) %>%
    mutate(
        techniques = c("wf","cmp", "d2v1"),
        topic = "Immigration"
    )


cor_table_all <- bind_rows(cor_table_gen, cor_table_econ, cor_table_eu, 
                           cor_table_socwel, cor_table_imm, cor_table_env) %>%
    mutate(
        topic = factor(topic, levels = c("General","Economics",
                                         "Labour and Social Welfare",
                                         "Immigration",
                                         "European Integration",
                                         "Environment - Growth",
                                         "Environment Protection"))
    )
```

## Figure A2

```{r figure a2}
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#0072B2", "#F0E442", "#D55E00", "#CC79A7")

plot_cor_ches <- ggplot(data = cor_table_all, aes(x = topic, y = abs(cor), fill = factor(techniques))) +
    geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
    scale_fill_manual(name = "Techniques",  
                      labels = c("MARPOR - Log", "R&C - Dim 1", "Wordfish"),
                      values = cbbPalette[2:5]) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + # Wrap x-axis labels
    xlab("Topic") +
    ylab("Correlation to ContextScale") +
    theme_bw(base_size = 18) +
    theme(legend.position = "top")

figure_a2 <- plot_cor_ches
agg_png(filename = here::here("results", "tabs and figs", "figure A2.png"), res = 360, width = 4800, height = 3200)
print(figure_a2)
invisible(dev.off())

```


## Figure A3

```{r figure_a3}

figure_a3 <- ggplot(manifesto_cs_topic %>% filter(topic != "Other"), aes(x = mean_position_score, y = aleatoric_variance)) +
  geom_hex(bins = 60) +
  scale_fill_viridis_c(option = "cividis", trans = "sqrt", name = "Count", direction = -1) +
  geom_rug(alpha = 0.25, sides = "b") +
  coord_cartesian(xlim = c(-1, 1)) +
  labs(
    x = "Position Score (-1 = Left, 1 = Right)",
    y = "Aleatoric Variance",
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12),
    panel.grid = element_blank(),
    legend.position = "right"
  )


# Save to results/tabs and figs/figure a3.png
agg_png(filename = here::here("results","tabs and figs","figure A3.png"),
        res = 360, width = 3600, height = 2400)
print(figure_a3)
invisible(dev.off())



```
